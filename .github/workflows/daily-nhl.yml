name: Daily NHL Data Fetch

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  fetch-nhl:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Tailor NHL Data
        run: |
          # 1. Set the date for Today in EST to ensure we fetch the correct schedule
          # Using America/New_York handles Daylight Savings automatically.
          TODAY=$(TZ="America/New_York" date +%Y-%m-%d)
          
          echo "Fetching NHL schedule starting from $TODAY (EST)..."

          # 2. Fetch from Official NHL API
          # 3. Use JQ to convert the UTC time from the API into EST for your website
          # We subtract 5 hours from the UTC time to get the correct EST date/time.
          curl -s "https://api-web.nhle.com/v1/schedule/$TODAY" | jq '{
            games: [
              .gameWeek[].games[] | {
                date: (.startTimeUTC | fromdateiso8601 - 18000 | strftime("%Y-%m-%d")),
                # added 'T' and ':000Z' for convenience 
                time: (.startTimeUTC | fromdateiso8601 - 18000 | "T" + strftime("%H:%M:%S") + ":000Z"),
                home: .homeTeam.commonName.default,
                visitor: .awayTeam.commonName.default
              }
            ]
          }' > nhl_data.json

      - name: Push NHL file back to GitHub
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Robot"
          git add nhl_data.json
          git commit -m "Automated NHL update (EST): $(date +%Y-%m-%d)" || exit 0
          git push
